@inherits LayoutComponentBase
@implements IDisposable
@inject IRecipeService RecipeService
@inject AppState AppState

<div class="layout-container">
    <!-- Sidebar - Desktop only -->
    <aside class="sidebar @(isSidebarCollapsed ? "collapsed" : "")" data-testid="sidebar">
        <!-- Logo -->
        <div class="sidebar-header" @onclick="ToggleSidebar" title="Toggle Sidebar" data-testid="sidebar-header">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.1 13.34l2.83-2.83L3.91 3.5c-1.56 1.56-1.56 4.09 0 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.46-1.46-4.2-1.1-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 13l1.47-1.47z"/>
                    </svg>
                </div>
                <span class="logo-text" data-testid="sidebar-logo-text">CÄƒmara CulinarÄƒ</span>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="sidebar-nav" data-testid="sidebar-nav">
            <NavLink href="/" class="nav-link" Match="NavLinkMatch.All" data-testid="nav-link-home">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span>AcasÄƒ</span>
            </NavLink>
            
            <NavLink href="/recipes/new" class="nav-link">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span>ReÈ›etÄƒ NouÄƒ</span>
            </NavLink>
            
            <NavLink href="/favorites" class="nav-link">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
                <span>Favorite</span>
            </NavLink>
            
            <!-- Categories Section -->
            @if (cuisineTypes != null && cuisineTypes.Count > 0)
            {
                <div class="nav-section">
                    <div class="nav-section-header">
                        <h3 class="nav-section-title">Categorii</h3>
                        <button @onclick="RefreshCategories" class="refresh-btn" title="ReÃ®mprospÄƒteazÄƒ categoriile">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                    </div>
                    @foreach (var cuisine in cuisineTypes)
                    {
                        <NavLink href="@($"/cuisine/{Uri.EscapeDataString(cuisine)}")" class="nav-link">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                            </svg>
                            <span>@cuisine</span>
                        </NavLink>
                    }
                </div>
            }
        </nav>
        
        <!-- Footer Tip -->
        <div class="sidebar-footer">
            <div class="tip-box">
                <div class="tip-box-title">ðŸ’¡ Sfatul BucÄƒtarului</div>
                <p class="tip-box-text">LÄƒsaÈ›i carnea la temperatura camerei 30 de minute Ã®nainte de gÄƒtit pentru rezultate perfecte.</p>
            </div>
        </div>
    </aside>
    
    <!-- Mobile Header -->
    <header class="mobile-header">
        <div class="mobile-header-content">
            <a href="/" class="logo">
                <div class="logo-icon logo-icon-sm">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.1 13.34l2.83-2.83L3.91 3.5c-1.56 1.56-1.56 4.09 0 5.66l4.19 4.18z"/>
                    </svg>
                </div>
                <span class="logo-text">CÄƒmara CulinarÄƒ</span>
            </a>
            <button @onclick="ToggleMobileMenu" class="mobile-menu-btn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    @if (showMobileMenu)
                    {
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    }
                    else
                    {
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    }
                </svg>
            </button>
        </div>
    </header>
    
    <!-- Mobile Menu Overlay -->
    @if (showMobileMenu)
    {
        <div class="mobile-overlay" @onclick="ToggleMobileMenu"></div>
        <div class="mobile-menu">
            <nav class="mobile-nav">
                <a href="/" class="nav-link" @onclick="ToggleMobileMenu">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span>AcasÄƒ</span>
                </a>
                <a href="/recipes/new" class="nav-link" @onclick="ToggleMobileMenu">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span>ReÈ›etÄƒ NouÄƒ</span>
                </a>
                <a href="/favorites" class="nav-link" @onclick="ToggleMobileMenu">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                    <span>Favorite</span>
                </a>
            </nav>
        </div>
    }
    
    <!-- Main Content -->
    <main class="main-content" data-testid="main-content">
        @Body
    </main>
</div>

<style>
    .layout-container {
        display: flex;
        min-height: 100vh;
        background-color: #f9fafb;
    }
    
    /* Sidebar */
    .sidebar {
        display: none;
        width: 240px;
        background-color: #2C3E50;
        flex-direction: column;
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        z-index: 40;
        transition: width 0.3s ease;
        overflow-x: hidden;
    }

    .sidebar.collapsed {
        width: 80px;
    }
    
    .sidebar-header {
        padding: 1.25rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        width: 240px; /* Ensure content stays stable during transition */
    }

    .sidebar.collapsed .sidebar-header {
        width: 80px; 
        padding: 1.25rem 0.5rem; /* Adjust padding */
        display: flex;
        justify-content: center;
    }
    
    .logo {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        text-decoration: none;
        white-space: nowrap; /* Prevent text wrapping */
    }

    .sidebar.collapsed .logo {
        justify-content: center;
        padding-left: 5px;
    }

    .sidebar.collapsed .logo-text {
        display: none;
        opacity: 0;
    }
    
    .sidebar.collapsed .nav-link span {
        display: none;
    }
    
    .sidebar.collapsed .nav-section-title {
        display: none;
    }
    
    .sidebar.collapsed .nav-link {
        justify-content: center;
        padding: 0.625rem 0;
    }
    
    .sidebar.collapsed .sidebar-footer {
        display: none;
    }
    
    .logo-icon {
        width: 36px;
        height: 36px;
        background: rgba(231, 76, 60, 0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .logo-icon svg {
        width: 20px;
        height: 20px;
        color: #E74C3C;
    }
    
    .logo-icon-sm {
        width: 32px;
        height: 32px;
    }
    
    .logo-icon-sm svg {
        width: 16px;
        height: 16px;
    }
    
    .logo-text {
        font-size: 1.125rem;
        font-weight: 700;
        color: #ffffff;
        font-family: 'Playfair Display', Georgia, serif;
    }
    
    .sidebar-nav {
        flex: 1;
        padding: 0.75rem;
        overflow-y: auto;
    }
    
    .nav-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-right: 0.75rem;
    }

    .nav-section-title {
        padding: 0.5rem 0.75rem;
        font-size: 0.6875rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.4);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin: 0;
    }

    .refresh-btn {
        padding: 0.25rem;
        color: rgba(255, 255, 255, 0.4);
        background: transparent;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .refresh-btn:hover {
        color: #E74C3C;
        background: rgba(255, 255, 255, 0.1);
    }

    .sidebar.collapsed .refresh-btn {
        display: none;
    }
    
    .nav-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.625rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.9375rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        transition: all 0.15s ease;
        margin-bottom: 0.125rem;
    }
    
    .nav-link svg {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
    }
    
    .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.08);
        color: #ffffff;
    }
    
    .nav-link.active {
        background-color: rgba(231, 76, 60, 0.15);
        color: #ffffff;
    }
    
    .nav-link.active svg {
        color: #E74C3C;
    }
    
    .sidebar-footer {
        padding: 0.75rem;
    }
    
    .tip-box {
        padding: 1rem;
        background: rgba(255, 255, 255, 0.06);
        border-radius: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .tip-box-title {
        font-size: 0.8125rem;
        font-weight: 600;
        color: #E74C3C;
        margin-bottom: 0.375rem;
    }
    
    .tip-box-text {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
        line-height: 1.5;
        margin: 0;
    }
    
    /* Mobile Header */
    .mobile-header {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background-color: #2C3E50;
        z-index: 50;
    }
    
    .mobile-header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.875rem 1rem;
    }
    
    .mobile-menu-btn {
        padding: 0.5rem;
        background: transparent;
        border: none;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .mobile-menu-btn:hover {
        color: #ffffff;
    }
    
    .mobile-menu-btn svg {
        width: 24px;
        height: 24px;
    }
    
    .mobile-overlay {
        display: block;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 40;
    }
    
    .mobile-menu {
        display: block;
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        background: #2C3E50;
        z-index: 50;
        padding: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    
    .mobile-nav {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    /* Main Content */
    .main-content {
        flex: 1;
        padding: 1.25rem;
        padding-top: calc(60px + 1.25rem); /* Account for mobile header */
        min-height: 100vh;
    }
    
    /* Desktop Styles */
    @@media (min-width: 768px) {
        .sidebar {
            display: flex;
        }
        
        .mobile-header,
        .mobile-overlay,
        .mobile-menu {
            display: none !important;
        }
        
        .main-content {
            margin-left: 240px;
            padding: 2rem;
            padding-top: 2rem;
            transition: margin-left 0.3s ease;
        }

        .sidebar.collapsed ~ .main-content {
            margin-left: 80px;
        }
    }
</style>

@code {
    private List<string>? cuisineTypes;
    private bool showMobileMenu = false;
    private bool isSidebarCollapsed = false;

    protected override async Task OnInitializedAsync()
    {
        cuisineTypes = await RecipeService.GetCuisineTypesAsync();
        AppState.OnRecipeDeleted += HandleRecipeDeleted;
        AppState.OnRecipeCreated += HandleRecipeChanged;
        AppState.OnRecipeUpdated += HandleRecipeChanged;
    }

    private async void HandleRecipeDeleted()
    {
        await InvokeAsync(async () =>
        {
            await RefreshCategories();
        });
    }

    private async void HandleRecipeChanged()
    {
        await InvokeAsync(async () =>
        {
            await RefreshCategories();
        });
    }

    private void ToggleMobileMenu()
    {
        showMobileMenu = !showMobileMenu;
    }

    private void ToggleSidebar()
    {
        isSidebarCollapsed = !isSidebarCollapsed;
    }

    private async Task RefreshCategories()
    {
        cuisineTypes = await RecipeService.GetCuisineTypesAsync();
        StateHasChanged();
    }

    public void Dispose()
    {
        AppState.OnRecipeDeleted -= HandleRecipeDeleted;
        AppState.OnRecipeCreated -= HandleRecipeChanged;
        AppState.OnRecipeUpdated -= HandleRecipeChanged;
    }
}
