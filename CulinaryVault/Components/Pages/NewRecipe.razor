@page "/recipes/new"
@inject IRecipeService RecipeService
@inject NavigationManager Navigation

<PageTitle>Rețetă Nouă - Cămara Culinară</PageTitle>

<div class="max-w-3xl mx-auto">
    <div class="flex items-center gap-4 mb-6">
        <a href="/" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 class="text-3xl font-bold text-gray-800 font-title">Rețetă Nouă</h1>
    </div>
    
    <EditForm Model="recipe" OnValidSubmit="HandleSubmit" class="space-y-6">
        <DataAnnotationsValidator />
        
        <!-- Basic Info -->
        <div class="bg-white rounded-2xl p-6 border border-gray-100 space-y-4">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Informații de bază</h2>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Titlu *</label>
                <InputText @bind-Value="recipe.Title" class="form-input" placeholder="ex: Sarmale tradiționale" data-testid="title-input" />
                <ValidationMessage For="@(() => recipe.Title)" class="text-red-500 text-sm mt-1" />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Descriere</label>
                <InputTextArea @bind-Value="recipe.Description" class="form-input min-h-24" placeholder="Descrie rețeta ta..." data-testid="description-input" />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">URL Imagine</label>
                <InputText @bind-Value="recipe.ImageUrl" class="form-input" placeholder="https://example.com/image.jpg" data-testid="image-url-input" />
                @if (!string.IsNullOrEmpty(recipe.ImageUrl))
                {
                    <img src="@recipe.ImageUrl" alt="Preview" class="mt-2 h-32 w-auto rounded-lg object-cover" />
                }
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tip Bucătărie</label>
                    <InputText @bind-Value="recipe.CuisineType" class="form-input" list="cuisineTypes" placeholder="ex: Românească" data-testid="cuisine-type-input" />
                    <datalist id="cuisineTypes">
                        @if (existingCuisineTypes != null)
                        {
                            @foreach (var cuisine in existingCuisineTypes)
                            {
                                <option value="@cuisine" />
                            }
                        }
                    </datalist>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dificultate</label>
                    <InputSelect @bind-Value="recipe.Difficulty" class="form-input" data-testid="difficulty-select">
                        <option value="@Difficulty.Easy">Ușor</option>
                        <option value="@Difficulty.Medium">Mediu</option>
                        <option value="@Difficulty.Hard">Greu</option>
                        <option value="@Difficulty.Expert">Expert</option>
                    </InputSelect>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Timp preparare (min)</label>
                    <InputNumber @bind-Value="prepTimeMinutes" class="form-input" min="0" data-testid="prep-time-input" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Timp gătit (min)</label>
                    <InputNumber @bind-Value="cookTimeMinutes" class="form-input" min="0" data-testid="cook-time-input" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Porții</label>
                    <InputNumber @bind-Value="recipe.Servings" class="form-input" min="1" max="100" data-testid="servings-input" />
                </div>
            </div>
        </div>
        
        <!-- Ingredients -->
        <div class="bg-white rounded-2xl p-6 border border-gray-100" data-testid="ingredients-section">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Ingrediente</h2>
                <button type="button" @onclick="AddIngredient" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-sm" data-testid="add-ingredient-button">
                    + Adaugă
                </button>
            </div>

            <div class="space-y-3" data-testid="ingredients-list">
                @for (int i = 0; i < recipe.Ingredients.Count; i++)
                {
                    var index = i;
                    <div class="flex items-center gap-2" data-testid="ingredient-row">
                        <input type="number" @bind="recipe.Ingredients[index].Amount" step="0.1" min="0" class="w-20 form-input" placeholder="Cant." data-testid="ingredient-amount" />
                        <input type="text" @bind="recipe.Ingredients[index].Unit" class="w-24 form-input" placeholder="Unitate" data-testid="ingredient-unit" />
                        <input type="text" @bind="recipe.Ingredients[index].Name" class="flex-1 form-input" placeholder="Ingredient" data-testid="ingredient-name" />
                        <button type="button" @onclick="() => RemoveIngredient(index)" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                }
            </div>
            
            @if (recipe.Ingredients.Count == 0)
            {
                <p class="text-gray-400 text-center py-4">Niciun ingredient adăugat</p>
            }
        </div>
        
        <!-- Instructions -->
        <div class="bg-white rounded-2xl p-6 border border-gray-100" data-testid="instructions-section">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Instrucțiuni</h2>
                <button type="button" @onclick="AddInstruction" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-sm" data-testid="add-instruction-button">
                    + Adaugă Pas
                </button>
            </div>

            <div class="space-y-3" data-testid="instructions-list">
                @for (int i = 0; i < recipe.Instructions.Count; i++)
                {
                    var index = i;
                    <div class="flex items-start gap-3" data-testid="instruction-row">
                        <span class="flex-shrink-0 w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center font-bold text-sm mt-2">
                            @(index + 1)
                        </span>
                        <textarea @bind="recipe.Instructions[index].Text" class="flex-1 form-input min-h-20" placeholder="Descrie pasul..." data-testid="instruction-text"></textarea>
                        <button type="button" @onclick="() => RemoveInstruction(index)" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors mt-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                }
            </div>
            
            @if (recipe.Instructions.Count == 0)
            {
                <p class="text-gray-400 text-center py-4">Nicio instrucțiune adăugată</p>
            }
        </div>
        
        <!-- Submit -->
        <div class="flex items-center justify-end gap-4">
            <a href="/" class="px-6 py-3 text-gray-600 hover:text-gray-800 transition-colors">Anulează</a>
            <button type="submit" disabled="@isSubmitting" class="px-6 py-3 bg-accent text-white rounded-xl hover:bg-red-600 transition-colors disabled:opacity-50" data-testid="submit-button">
                @if (isSubmitting)
                {
                    <span class="flex items-center gap-2">
                        <span class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                        Se salvează...
                    </span>
                }
                else
                {
                    <span>Salvează Rețeta</span>
                }
            </button>
        </div>
    </EditForm>
</div>

<style>
    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        transition: all 0.2s;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #E74C3C;
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
    }
</style>

@code {
    private Recipe recipe = new()
    {
        Servings = 4,
        CuisineType = "General",
        Difficulty = Difficulty.Medium
    };
    
    private List<string>? existingCuisineTypes;
    private int prepTimeMinutes = 30;
    private int cookTimeMinutes = 30;
    private bool isSubmitting = false;

    protected override async Task OnInitializedAsync()
    {
        existingCuisineTypes = await RecipeService.GetCuisineTypesAsync();
    }

    private void AddIngredient()
    {
        recipe.Ingredients.Add(new Ingredient
        {
            Id = Guid.NewGuid(),
            Order = recipe.Ingredients.Count + 1
        });
    }

    private void RemoveIngredient(int index)
    {
        recipe.Ingredients.RemoveAt(index);
        for (int i = 0; i < recipe.Ingredients.Count; i++)
        {
            recipe.Ingredients[i].Order = i + 1;
        }
    }

    private void AddInstruction()
    {
        recipe.Instructions.Add(new Instruction
        {
            Id = Guid.NewGuid(),
            StepNumber = recipe.Instructions.Count + 1
        });
    }

    private void RemoveInstruction(int index)
    {
        recipe.Instructions.RemoveAt(index);
        for (int i = 0; i < recipe.Instructions.Count; i++)
        {
            recipe.Instructions[i].StepNumber = i + 1;
        }
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        try
        {
            recipe.PrepTime = TimeSpan.FromMinutes(prepTimeMinutes);
            recipe.CookTime = TimeSpan.FromMinutes(cookTimeMinutes);
            
            var created = await RecipeService.CreateRecipeAsync(recipe);
            Navigation.NavigateTo($"/recipes/{created.Id}");
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
