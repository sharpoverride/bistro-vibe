@page "/recipes/new"
@inject IRecipeService RecipeService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Rețetă Nouă - Cămara Culinară</PageTitle>

<div class="max-w-3xl mx-auto">
    <div class="flex items-center gap-4 mb-6">
        <a href="/" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 class="text-3xl font-bold text-gray-800 font-title">Rețetă Nouă</h1>
    </div>
    
    <EditForm Model="recipe" OnValidSubmit="HandleSubmit" class="space-y-6">
        <DataAnnotationsValidator />
        
        <!-- Basic Info -->
        <div class="bg-white rounded-2xl p-6 border border-gray-100 space-y-4">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Informații de bază</h2>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Titlu *</label>
                <InputText @bind-Value="recipe.Title" class="form-input" placeholder="ex: Sarmale tradiționale" data-testid="title-input" />
                <ValidationMessage For="@(() => recipe.Title)" class="text-red-500 text-sm mt-1" />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Descriere</label>
                <InputTextArea @bind-Value="recipe.Description" class="form-input min-h-24" placeholder="Descrie rețeta ta..." data-testid="description-input" />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">URL Imagine</label>
                <InputText @bind-Value="recipe.ImageUrl" class="form-input" placeholder="https://example.com/image.jpg" data-testid="image-url-input" />
                @if (!string.IsNullOrEmpty(recipe.ImageUrl))
                {
                    <img src="@recipe.ImageUrl" alt="Preview" class="mt-2 h-32 w-auto rounded-lg object-cover" />
                }
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tip Bucătărie</label>
                    <InputText @bind-Value="recipe.CuisineType" class="form-input" list="cuisineTypes" placeholder="ex: Românească" data-testid="cuisine-type-input" />
                    <datalist id="cuisineTypes">
                        @if (existingCuisineTypes != null)
                        {
                            @foreach (var cuisine in existingCuisineTypes)
                            {
                                <option value="@cuisine" />
                            }
                        }
                    </datalist>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dificultate</label>
                    <InputSelect @bind-Value="recipe.Difficulty" class="form-input" data-testid="difficulty-select">
                        <option value="@Difficulty.Easy">Ușor</option>
                        <option value="@Difficulty.Medium">Mediu</option>
                        <option value="@Difficulty.Hard">Greu</option>
                        <option value="@Difficulty.Expert">Expert</option>
                    </InputSelect>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Timp preparare (min)</label>
                    <InputNumber @bind-Value="prepTimeMinutes" class="form-input" min="0" data-testid="prep-time-input" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Timp gătit (min)</label>
                    <InputNumber @bind-Value="cookTimeMinutes" class="form-input" min="0" data-testid="cook-time-input" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Porții</label>
                    <InputNumber @bind-Value="recipe.Servings" class="form-input" min="1" max="100" data-testid="servings-input" />
                </div>
            </div>
        </div>
        
        <!-- Ingredients -->
        <div class="bg-white rounded-2xl p-6 border border-gray-100" data-testid="ingredients-section">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Ingrediente</h2>
                <button type="button" @onclick="AddIngredient" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-sm" data-testid="add-ingredient-button">
                    + Adaugă
                </button>
            </div>

            <div class="space-y-2" data-testid="ingredients-list">
                @for (int i = 0; i < recipe.Ingredients.Count; i++)
                {
                    var index = i;
                    <div class="ingredient-row group"
                         draggable="true"
                         @ondragstart="@(() => HandleIngredientDragStart(index))"
                         @ondrop="@(() => HandleIngredientDrop(index))"
                         @ondragover:preventDefault
                         data-testid="ingredient-row"
                         data-drag-item="ingredient"
                         data-drag-index="@index">

                        <div class="drag-handle" data-testid="ingredient-drag-handle" data-drag-handle>
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                            </svg>
                        </div>

                        <input type="number" @bind="recipe.Ingredients[index].Amount" step="0.1" min="0"
                               class="form-input text-center" placeholder="Cant." data-testid="ingredient-amount" />
                        <input type="text" @bind="recipe.Ingredients[index].Unit"
                               class="form-input" placeholder="Unitate" data-testid="ingredient-unit" />
                        <input type="text" @bind="recipe.Ingredients[index].Name"
                               class="form-input ingredient-name" placeholder="Nume ingredient" data-testid="ingredient-name" />

                        <button type="button" @onclick="() => RemoveIngredient(index)"
                                class="delete-btn" data-testid="ingredient-delete">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                }
            </div>

            @if (recipe.Ingredients.Count == 0)
            {
                <p class="text-gray-400 text-center py-4">Niciun ingredient adăugat</p>
            }
        </div>
        
        <!-- Instructions -->
        <div class="bg-white rounded-2xl p-6 border border-gray-100" data-testid="instructions-section">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Instrucțiuni</h2>
                <button type="button" @onclick="AddInstruction" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-sm" data-testid="add-instruction-button">
                    + Adaugă Pas
                </button>
            </div>

            <div class="space-y-3" data-testid="instructions-list">
                @for (int i = 0; i < recipe.Instructions.Count; i++)
                {
                    var index = i;
                    <div class="flex items-start gap-3 p-2 bg-slate-50 rounded-lg border border-transparent hover:border-gray-200 transition-colors group"
                         draggable="true"
                         @ondragstart="@(() => HandleInstructionDragStart(index))"
                         @ondrop="@(() => HandleInstructionDrop(index))"
                         @ondragover:preventDefault
                         data-testid="instruction-row"
                         data-drag-item="instruction"
                         data-drag-index="@index">

                        <div class="cursor-grab active:cursor-grabbing text-gray-400 hover:text-accent p-1 mt-2" data-testid="instruction-drag-handle" data-drag-handle>
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                            </svg>
                        </div>

                        <span class="flex-shrink-0 w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center font-bold text-sm mt-2">
                            @(index + 1)
                        </span>
                        <textarea @bind="recipe.Instructions[index].Text" class="flex-1 form-input min-h-20" placeholder="Descrie pasul..." data-testid="instruction-text"></textarea>
                        <button type="button" @onclick="() => RemoveInstruction(index)" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors mt-2 opacity-50 group-hover:opacity-100" data-testid="instruction-delete">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                }
            </div>

            @if (recipe.Instructions.Count == 0)
            {
                <p class="text-gray-400 text-center py-4">Nicio instrucțiune adăugată</p>
            }
        </div>
        
        <!-- Submit -->
        <div class="flex items-center justify-end gap-4">
            <a href="/" class="px-6 py-3 text-gray-600 hover:text-gray-800 transition-colors">Anulează</a>
            <button type="submit" disabled="@isSubmitting" class="px-6 py-3 bg-accent text-white rounded-xl hover:bg-red-600 transition-colors disabled:opacity-50" data-testid="submit-button">
                @if (isSubmitting)
                {
                    <span class="flex items-center gap-2">
                        <span class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                        Se salvează...
                    </span>
                }
                else
                {
                    <span>Salvează Rețeta</span>
                }
            </button>
        </div>
    </EditForm>
</div>

<style>
    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        transition: all 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: #E74C3C;
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
    }

    .ingredient-row {
        display: grid;
        grid-template-columns: auto 70px 90px 1fr auto;
        gap: 0.5rem;
        align-items: center;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 0.75rem;
        border: 1px solid transparent;
        transition: border-color 0.2s;
    }

    .ingredient-row:hover {
        border-color: #e5e7eb;
    }

    .ingredient-row .drag-handle {
        cursor: grab;
        color: #9ca3af;
        padding: 0.25rem;
    }

    .ingredient-row .drag-handle:hover {
        color: #E74C3C;
    }

    .ingredient-row .drag-handle:active {
        cursor: grabbing;
    }

    .ingredient-row .delete-btn {
        padding: 0.5rem;
        color: #ef4444;
        border-radius: 0.5rem;
        opacity: 0.5;
        transition: all 0.2s;
    }

    .ingredient-row:hover .delete-btn {
        opacity: 1;
    }

    .ingredient-row .delete-btn:hover {
        background: #fef2f2;
    }

    .ingredient-row .ingredient-name {
        min-width: 0;
    }

    /* Touch-friendly drag handle styles */
    .drag-handle {
        touch-action: none;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        min-width: 32px;
        min-height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    @@media (pointer: coarse) {
        .drag-handle,
        [data-drag-handle] {
            min-width: 44px;
            min-height: 44px;
        }
    }

    [data-drag-handle] {
        touch-action: none;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
    }
</style>

@code {
    private Recipe recipe = new()
    {
        Servings = 4,
        CuisineType = "General",
        Difficulty = Difficulty.Medium
    };

    private List<string>? existingCuisineTypes;
    private int prepTimeMinutes = 30;
    private int cookTimeMinutes = 30;
    private bool isSubmitting = false;
    private int? draggedIngredientIndex;
    private int? draggedInstructionIndex;
    private DotNetObjectReference<NewRecipe>? dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        existingCuisineTypes = await RecipeService.GetCuisineTypesAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("touchDrag.initialize", dotNetRef);
        }
    }

    [JSInvokable]
    public void HandleTouchDrop(string itemType, int fromIndex, int toIndex)
    {
        if (itemType == "ingredient")
        {
            if (fromIndex >= 0 && fromIndex < recipe.Ingredients.Count &&
                toIndex >= 0 && toIndex <= recipe.Ingredients.Count)
            {
                var item = recipe.Ingredients[fromIndex];
                recipe.Ingredients.RemoveAt(fromIndex);
                if (toIndex > fromIndex) toIndex--;
                if (toIndex < 0) toIndex = 0;
                if (toIndex > recipe.Ingredients.Count) toIndex = recipe.Ingredients.Count;
                recipe.Ingredients.Insert(toIndex, item);

                for (int i = 0; i < recipe.Ingredients.Count; i++)
                {
                    recipe.Ingredients[i].Order = i + 1;
                }
            }
        }
        else if (itemType == "instruction")
        {
            if (fromIndex >= 0 && fromIndex < recipe.Instructions.Count &&
                toIndex >= 0 && toIndex <= recipe.Instructions.Count)
            {
                var item = recipe.Instructions[fromIndex];
                recipe.Instructions.RemoveAt(fromIndex);
                if (toIndex > fromIndex) toIndex--;
                if (toIndex < 0) toIndex = 0;
                if (toIndex > recipe.Instructions.Count) toIndex = recipe.Instructions.Count;
                recipe.Instructions.Insert(toIndex, item);

                for (int i = 0; i < recipe.Instructions.Count; i++)
                {
                    recipe.Instructions[i].StepNumber = i + 1;
                }
            }
        }

        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (dotNetRef != null)
        {
            await JSRuntime.InvokeVoidAsync("touchDrag.dispose");
            dotNetRef.Dispose();
        }
    }

    private void AddIngredient()
    {
        recipe.Ingredients.Add(new Ingredient
        {
            Id = Guid.NewGuid(),
            Order = recipe.Ingredients.Count + 1
        });
    }

    private void RemoveIngredient(int index)
    {
        recipe.Ingredients.RemoveAt(index);
        for (int i = 0; i < recipe.Ingredients.Count; i++)
        {
            recipe.Ingredients[i].Order = i + 1;
        }
    }

    private void AddInstruction()
    {
        recipe.Instructions.Add(new Instruction
        {
            Id = Guid.NewGuid(),
            StepNumber = recipe.Instructions.Count + 1
        });
    }

    private void RemoveInstruction(int index)
    {
        recipe.Instructions.RemoveAt(index);
        for (int i = 0; i < recipe.Instructions.Count; i++)
        {
            recipe.Instructions[i].StepNumber = i + 1;
        }
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        try
        {
            recipe.PrepTime = TimeSpan.FromMinutes(prepTimeMinutes);
            recipe.CookTime = TimeSpan.FromMinutes(cookTimeMinutes);

            var created = await RecipeService.CreateRecipeAsync(recipe);
            Navigation.NavigateTo($"/recipes/{created.Id}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void HandleIngredientDragStart(int index)
    {
        draggedIngredientIndex = index;
    }

    private void HandleIngredientDrop(int dropIndex)
    {
        if (draggedIngredientIndex == null) return;

        var draggedIndex = draggedIngredientIndex.Value;
        if (draggedIndex != dropIndex)
        {
            var item = recipe.Ingredients[draggedIndex];
            recipe.Ingredients.RemoveAt(draggedIndex);

            // Adjust drop index if removal shifted indices
            if (dropIndex > draggedIndex) dropIndex--;
            else if (dropIndex < 0) dropIndex = 0;

            recipe.Ingredients.Insert(dropIndex, item);

            // Re-assign Order
            for (int i = 0; i < recipe.Ingredients.Count; i++)
            {
                recipe.Ingredients[i].Order = i + 1;
            }
        }
        draggedIngredientIndex = null;
    }

    private void HandleInstructionDragStart(int index)
    {
        draggedInstructionIndex = index;
    }

    private void HandleInstructionDrop(int dropIndex)
    {
        if (draggedInstructionIndex == null) return;

        var draggedIndex = draggedInstructionIndex.Value;
        if (draggedIndex != dropIndex)
        {
            var item = recipe.Instructions[draggedIndex];
            recipe.Instructions.RemoveAt(draggedIndex);

            // Adjust drop index if removal shifted indices
            if (dropIndex > draggedIndex) dropIndex--;
            else if (dropIndex < 0) dropIndex = 0;

            recipe.Instructions.Insert(dropIndex, item);

            // Re-assign StepNumber
            for (int i = 0; i < recipe.Instructions.Count; i++)
            {
                recipe.Instructions[i].StepNumber = i + 1;
            }
        }
        draggedInstructionIndex = null;
    }
}
