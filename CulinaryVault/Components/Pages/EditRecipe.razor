@page "/recipes/{Id:guid}/edit"
@inject IRecipeService RecipeService
@inject NavigationManager Navigation
@inject AppState AppState
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Editează Rețeta - Cămara Culinară</PageTitle>

@if (recipe == null)
{
    <div class="flex items-center justify-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent"></div>
    </div>
}
else
{
    <div class="max-w-3xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
                <a href="/recipes/@Id" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </a>
                <h1 class="text-3xl font-bold text-gray-800 font-title">Editează Rețeta</h1>
            </div>
            <button @onclick="DeleteRecipe" class="px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors flex items-center gap-2" data-testid="delete-button">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Șterge
            </button>
        </div>
        
        <EditForm Model="recipe" OnValidSubmit="HandleSubmit" class="space-y-6">
            <DataAnnotationsValidator />
            
            <!-- Basic Info -->
            <div class="bg-white rounded-2xl p-6 border border-gray-100 space-y-4">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Informații de bază</h2>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Titlu *</label>
                    <InputText @bind-Value="recipe.Title" class="form-input" placeholder="ex: Sarmale tradiționale" data-testid="title-input" />
                    <ValidationMessage For="@(() => recipe.Title)" class="text-red-500 text-sm mt-1" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descriere</label>
                    <InputTextArea @bind-Value="recipe.Description" class="form-input min-h-24" placeholder="Descrie rețeta ta..." data-testid="description-input" />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">URL Imagine</label>
                    <InputText @bind-Value="recipe.ImageUrl" class="form-input" placeholder="https://example.com/image.jpg" />
                    @if (!string.IsNullOrEmpty(recipe.ImageUrl))
                    {
                        <img src="@recipe.ImageUrl" alt="Preview" class="mt-2 h-32 w-auto rounded-lg object-cover" />
                    }
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tip Bucătărie</label>
                        <InputText @bind-Value="recipe.CuisineType" class="form-input" list="cuisineTypes" placeholder="ex: Românească" />
                        <datalist id="cuisineTypes">
                            @if (existingCuisineTypes != null)
                            {
                                @foreach (var cuisine in existingCuisineTypes)
                                {
                                    <option value="@cuisine" />
                                }
                            }
                        </datalist>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dificultate</label>
                        <InputSelect @bind-Value="recipe.Difficulty" class="form-input">
                            <option value="@Difficulty.Easy">Ușor</option>
                            <option value="@Difficulty.Medium">Mediu</option>
                            <option value="@Difficulty.Hard">Greu</option>
                            <option value="@Difficulty.Expert">Expert</option>
                        </InputSelect>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Timp preparare (min)</label>
                        <InputNumber @bind-Value="prepTimeMinutes" class="form-input" min="0" />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Timp gătit (min)</label>
                        <InputNumber @bind-Value="cookTimeMinutes" class="form-input" min="0" />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Porții</label>
                        <InputNumber @bind-Value="recipe.Servings" class="form-input" min="1" max="100" />
                    </div>
                </div>
            </div>
            
            <!-- Ingredients -->
            <div class="bg-white rounded-2xl p-6 border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Ingrediente</h2>
                    <button type="button" @onclick="AddIngredient" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-sm">
                        + Adaugă
                    </button>
                </div>
                
                <div class="space-y-2">
                    @for (int i = 0; i < recipe.Ingredients.Count; i++)
                    {
                        var index = i;
                        <div class="ingredient-row group"
                             draggable="true"
                             @ondragstart="@(() => HandleIngredientDragStart(index))"
                             @ondrop="@(() => HandleIngredientDrop(index))"
                             @ondragover:preventDefault
                             data-drag-item="ingredient"
                             data-drag-index="@index">

                            <div class="drag-handle" data-drag-handle>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                                </svg>
                            </div>

                            <input type="number" @bind="recipe.Ingredients[index].Amount" step="0.1" min="0" 
                                   class="form-input text-center" placeholder="Cant." />
                            <input type="text" @bind="recipe.Ingredients[index].Unit" 
                                   class="form-input" placeholder="Unitate" />
                            <input type="text" @bind="recipe.Ingredients[index].Name" 
                                   class="form-input ingredient-name" placeholder="Nume ingredient" />
                            
                            <button type="button" @onclick="() => RemoveIngredient(index)" 
                                    class="delete-btn">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    }
                </div>
                
                @if (recipe.Ingredients.Count == 0)
                {
                    <p class="text-gray-400 text-center py-4">Niciun ingredient adăugat</p>
                }
            </div>
            
            <!-- Instructions -->
            <div class="bg-white rounded-2xl p-6 border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">Instrucțiuni</h2>
                    <button type="button" @onclick="AddInstruction" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-sm">
                        + Adaugă Pas
                    </button>
                </div>
                
                <div class="space-y-3">
                    @for (int i = 0; i < recipe.Instructions.Count; i++)
                    {
                        var index = i;
                        <div class="flex items-start gap-3 p-2 bg-slate-50 rounded-lg border border-transparent hover:border-gray-200 transition-colors group"
                             draggable="true"
                             @ondragstart="@(() => HandleInstructionDragStart(index))"
                             @ondrop="@(() => HandleInstructionDrop(index))"
                             @ondragover:preventDefault
                             data-drag-item="instruction"
                             data-drag-index="@index">

                            <div class="cursor-grab active:cursor-grabbing text-gray-400 hover:text-accent p-1 mt-2" data-drag-handle>
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                                </svg>
                            </div>

                            <span class="flex-shrink-0 w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center font-bold text-sm mt-2">
                                @(index + 1)
                            </span>
                            <textarea @bind="recipe.Instructions[index].Text" class="flex-1 form-input min-h-20" placeholder="Descrie pasul..."></textarea>
                            <button type="button" @onclick="() => RemoveInstruction(index)" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors mt-2 opacity-50 group-hover:opacity-100">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    }
                </div>
                
                @if (recipe.Instructions.Count == 0)
                {
                    <p class="text-gray-400 text-center py-4">Nicio instrucțiune adăugată</p>
                }
            </div>
            
            <!-- Submit -->
            <div class="flex items-center justify-end gap-4">
                <a href="/recipes/@Id" class="px-6 py-3 text-gray-600 hover:text-gray-800 transition-colors">Anulează</a>
                <button type="submit" disabled="@isSubmitting" class="px-6 py-3 bg-accent text-white rounded-xl hover:bg-red-600 transition-colors disabled:opacity-50" data-testid="save-button">
                    @if (isSubmitting)
                    {
                        <span class="flex items-center gap-2">
                            <span class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                            Se salvează...
                        </span>
                    }
                    else
                    {
                        <span>Salvează Modificările</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>

    <!-- Delete Confirmation Dialog -->
    @if (showDeleteDialog)
    {
        <div class="fixed inset-0 z-50 flex items-center justify-center" data-testid="delete-dialog">
            <div class="fixed inset-0 bg-black/50" @onclick="CancelDelete"></div>
            <div class="relative bg-white rounded-2xl p-6 max-w-md mx-4 shadow-xl" data-testid="delete-dialog-content">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Șterge Rețeta</h3>
                <p class="text-gray-600 mb-6">Ești sigur că vrei să ștergi această rețetă? Această acțiune nu poate fi anulată.</p>
                <div class="flex justify-end gap-3">
                    <button @onclick="CancelDelete"
                            class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
                            data-testid="delete-cancel-button">
                        Anulează
                    </button>
                    <button @onclick="ConfirmDelete"
                            class="px-4 py-2 rounded-lg transition-colors cursor-pointer"
                            style="background-color: #ef4444; color: white;"
                            data-testid="delete-confirm-button">
                        Șterge
                    </button>
                </div>
            </div>
        </div>
    }
}

<style>
    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        transition: all 0.2s;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #E74C3C;
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
    }
    
    .ingredient-row {
        display: grid;
        grid-template-columns: auto 70px 90px 1fr auto;
        gap: 0.5rem;
        align-items: center;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 0.75rem;
        border: 1px solid transparent;
        transition: border-color 0.2s;
    }
    
    .ingredient-row:hover {
        border-color: #e5e7eb;
    }
    
    .ingredient-row .drag-handle {
        cursor: grab;
        color: #9ca3af;
        padding: 0.25rem;
    }
    
    .ingredient-row .drag-handle:hover {
        color: #E74C3C;
    }
    
    .ingredient-row .drag-handle:active {
        cursor: grabbing;
    }
    
    .ingredient-row .delete-btn {
        padding: 0.5rem;
        color: #ef4444;
        border-radius: 0.5rem;
        opacity: 0.5;
        transition: all 0.2s;
    }
    
    .ingredient-row:hover .delete-btn {
        opacity: 1;
    }
    
    .ingredient-row .delete-btn:hover {
        background: #fef2f2;
    }
    
    .ingredient-row .ingredient-name {
        min-width: 0;
    }

    /* Touch-friendly drag handle styles */
    .drag-handle {
        touch-action: none;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        min-width: 32px;
        min-height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    @@media (pointer: coarse) {
        .drag-handle,
        [data-drag-handle] {
            min-width: 44px;
            min-height: 44px;
        }
    }

    [data-drag-handle] {
        touch-action: none;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
    }
</style>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private Recipe? recipe;
    private List<string>? existingCuisineTypes;
    private int prepTimeMinutes;
    private int cookTimeMinutes;
    private bool isSubmitting = false;
    private bool showDeleteDialog = false;
    private int? draggedIngredientIndex;
    private int? draggedInstructionIndex;
    private DotNetObjectReference<EditRecipe>? dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        recipe = await RecipeService.GetRecipeByIdAsync(Id);
        if (recipe != null)
        {
            prepTimeMinutes = (int)recipe.PrepTime.TotalMinutes;
            cookTimeMinutes = (int)recipe.CookTime.TotalMinutes;
        }
        existingCuisineTypes = await RecipeService.GetCuisineTypesAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("touchDrag.initialize", dotNetRef);
        }
    }

    [JSInvokable]
    public void HandleTouchDrop(string itemType, int fromIndex, int toIndex)
    {
        if (recipe == null) return;

        if (itemType == "ingredient")
        {
            if (fromIndex >= 0 && fromIndex < recipe.Ingredients.Count &&
                toIndex >= 0 && toIndex <= recipe.Ingredients.Count)
            {
                var item = recipe.Ingredients[fromIndex];
                recipe.Ingredients.RemoveAt(fromIndex);
                if (toIndex > fromIndex) toIndex--;
                if (toIndex < 0) toIndex = 0;
                if (toIndex > recipe.Ingredients.Count) toIndex = recipe.Ingredients.Count;
                recipe.Ingredients.Insert(toIndex, item);

                for (int i = 0; i < recipe.Ingredients.Count; i++)
                {
                    recipe.Ingredients[i].Order = i + 1;
                }
            }
        }
        else if (itemType == "instruction")
        {
            if (fromIndex >= 0 && fromIndex < recipe.Instructions.Count &&
                toIndex >= 0 && toIndex <= recipe.Instructions.Count)
            {
                var item = recipe.Instructions[fromIndex];
                recipe.Instructions.RemoveAt(fromIndex);
                if (toIndex > fromIndex) toIndex--;
                if (toIndex < 0) toIndex = 0;
                if (toIndex > recipe.Instructions.Count) toIndex = recipe.Instructions.Count;
                recipe.Instructions.Insert(toIndex, item);

                for (int i = 0; i < recipe.Instructions.Count; i++)
                {
                    recipe.Instructions[i].StepNumber = i + 1;
                }
            }
        }

        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (dotNetRef != null)
        {
            await JSRuntime.InvokeVoidAsync("touchDrag.dispose");
            dotNetRef.Dispose();
        }
    }

    private void AddIngredient()
    {
        recipe?.Ingredients.Add(new Ingredient
        {
            Id = Guid.NewGuid(),
            Order = (recipe?.Ingredients.Count ?? 0) + 1
        });
    }

    private void RemoveIngredient(int index)
    {
        recipe?.Ingredients.RemoveAt(index);
        if (recipe != null)
        {
            for (int i = 0; i < recipe.Ingredients.Count; i++)
            {
                recipe.Ingredients[i].Order = i + 1;
            }
        }
    }

    private void AddInstruction()
    {
        recipe?.Instructions.Add(new Instruction
        {
            Id = Guid.NewGuid(),
            StepNumber = (recipe?.Instructions.Count ?? 0) + 1
        });
    }

    private void RemoveInstruction(int index)
    {
        recipe?.Instructions.RemoveAt(index);
        if (recipe != null)
        {
            for (int i = 0; i < recipe.Instructions.Count; i++)
            {
                recipe.Instructions[i].StepNumber = i + 1;
            }
        }
    }

    private async Task HandleSubmit()
    {
        if (recipe == null) return;
        
        isSubmitting = true;
        try
        {
            recipe.PrepTime = TimeSpan.FromMinutes(prepTimeMinutes);
            recipe.CookTime = TimeSpan.FromMinutes(cookTimeMinutes);
            
            await RecipeService.UpdateRecipeAsync(recipe);
            Navigation.NavigateTo($"/recipes/{recipe.Id}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void DeleteRecipe()
    {
        showDeleteDialog = true;
    }

    private void CancelDelete()
    {
        showDeleteDialog = false;
    }

    private async Task ConfirmDelete()
    {
        if (recipe != null)
        {
            await RecipeService.DeleteRecipeAsync(recipe.Id);
            AppState.NotifyRecipeDeleted();
            Navigation.NavigateTo("/");
        }
    }

    private void HandleIngredientDragStart(int index)
    {
        draggedIngredientIndex = index;
    }

    private void HandleIngredientDrop(int dropIndex)
    {
        if (recipe == null || draggedIngredientIndex == null) return;

        var draggedIndex = draggedIngredientIndex.Value;
        if (draggedIndex != dropIndex)
        {
            var item = recipe.Ingredients[draggedIndex];
            recipe.Ingredients.RemoveAt(draggedIndex);
            
            // Adjust drop index if removal shifted indices
            if (dropIndex > draggedIndex) dropIndex--;
            else if (dropIndex < 0) dropIndex = 0;
            
            recipe.Ingredients.Insert(dropIndex, item);
            
            // Re-assign Order
            for (int i = 0; i < recipe.Ingredients.Count; i++)
            {
                recipe.Ingredients[i].Order = i + 1;
            }
        }
        draggedIngredientIndex = null;
    }

    private void HandleInstructionDragStart(int index)
    {
        draggedInstructionIndex = index;
    }

    private void HandleInstructionDrop(int dropIndex)
    {
         if (recipe == null || draggedInstructionIndex == null) return;

        var draggedIndex = draggedInstructionIndex.Value;
        if (draggedIndex != dropIndex)
        {
            var item = recipe.Instructions[draggedIndex];
            recipe.Instructions.RemoveAt(draggedIndex);
            
             // Adjust drop index if removal shifted indices
            if (dropIndex > draggedIndex) dropIndex--;
            else if (dropIndex < 0) dropIndex = 0;

            recipe.Instructions.Insert(dropIndex, item);
            
            // Re-assign StepNumber
            for (int i = 0; i < recipe.Instructions.Count; i++)
            {
                recipe.Instructions[i].StepNumber = i + 1;
            }
        }
        draggedInstructionIndex = null;
    }
}
